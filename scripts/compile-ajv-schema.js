#! /usr/bin/env node
import path from 'node:path'
import Ajv from 'ajv'
import ajvErrors from 'ajv-errors'
import standaloneCode from 'ajv/dist/standalone/index.js'

const schemaFile = process.argv[2]

const ajv = new Ajv({
  // Output all errors at once when validating at runtime
  allErrors: true,

  code: {
    source: true,

    // Generate ESM code like the rest of the project.
    // This can be transpiled to CJS later
    esm: true
  }
})
// Decorate with ajv-errors to generate human readable errors from
// the custom `errorMessage` properties on the schema
ajvErrors(ajv)

const { default: schema } = await import(path.resolve(schemaFile))

const compiledValidator = ajv.compile(schema)
const moduleCode = standaloneCode(ajv, compiledValidator)

console.log('/// Autogenerated by `make` target `schemas`')
console.log(moduleCode)
